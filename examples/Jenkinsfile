@Library('ai-system-design-ci-metrics') _

pipeline {
  agent any
  environment {
    METRIC_ENDPOINT_URL = 'https://metrics.example.com/events'
    METRIC_CURL_TIMEOUT_SEC = '3'
  }

  stages {
    stage('Demo') {
      steps {
        script {
          metricStage('Top') {
            sh 'echo top work'

            metricParallel([
              'branch-a': {
                metricStage('A1') {
                  sh 'echo A1'
                }
                metricParallel([
                  'a-sub-1': {
                    metricStage('A-sub-1') { sh 'echo A-sub-1' }
                  },
                  'a-sub-2': {
                    metricStage('A-sub-2') { sh 'echo A-sub-2' }
                  }
                ])
              },
              'branch-b': {
                metricStage('B1') {
                  sh 'echo B1'
                }
              }
            ])

            metricStage('After Parallel') {
              sh 'echo done'
            }
          }
        }
      }
    }
  }
}
